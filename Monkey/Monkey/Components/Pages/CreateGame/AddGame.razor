@page "/game/create"
@using Monkey.Core.Services.GameServices
@using Monkey.Web.ViewModels.Game
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager NavigationManager
@inject IGameService gameService
@rendermode InteractiveServer
<h3>AddGame</h3>
<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
        <a class="navbar-brand" href="#">Board Games</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <li class="nav-item">
                    <a class="nav-link" href="/Account/Login">Начало</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/catalog">Каталог</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#">Статистики</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/contact">Свържи се с нас</a>
                </li>
                @if (isAdmin)
                {
                    <li class="nav-item">
                        <a class="nav-link" href="/game/create">Добави игра</a>
                    </li>
                }
            </ul>
        </div>
    </div>
</nav>
<EditForm method="post" Model="Game" OnValidSubmit="CreateGame" FormName="GameForm">
    <div>
        <label>Заглавие на игра</label>
        <InputText @bind-Value="Game.Name"></InputText>

        <br />
        <label>Описание на игра</label>
        <InputText @bind-Value="Game.Description"></InputText>

        <br />
        <label>Трудност</label>
        <InputNumber @bind-Value="Game.Difficulty"></InputNumber>

        <br />
        <label>Налични бройки</label>
        <InputNumber @bind-Value="Game.Count"></InputNumber>

        <br />
        <label>Изображение</label>
        <p>
            <label>
                Качете до @maxFileSize байтове:
                <InputFile OnChange="LoadFiles" />
            </label>
        </p>
        @if (isLoading)
        {
            <p>Uploading...</p>
        }
        else
        {
            <ul>
                @if (loadedFiles != null)
                {
                    <li>
                        <ul>
                            <li>Име на изображение: @loadedFiles.Name</li>
                            <li>Последно променена: @loadedFiles.LastModified.ToString()</li>
                            <li>Размер (битове): @loadedFiles.Size</li>
                            <li>Тип съдържание: @loadedFiles.ContentType</li>
                        </ul>
                    </li>
                }
            </ul>
        }
        <br />
    </div>

    <button type="submit">Публикувай</button>
    <p role="status">@Message</p>
</EditForm>

@code {
    [SupplyParameterFromForm(FormName = "GameForm")]
    public GameViewModel Game { get; set; } = new GameViewModel();
    bool isAdmin;

    public string Message { get; set; } = "";

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        var isAdmin = user.IsInRole("Admin");      

        if (!isAdmin)
        {
            NavigationManager.NavigateTo("/");
        }
    }

    public async void CreateGame()
    {
        if (Game.Difficulty < 1 || Game.Difficulty > 4)
        {
            Message = "Трудността трябва да бъде в диапазона от 1 до 4.";
            return;
        }

        if (loadedFiles == null)
        {
            Message = "Липсва снимка";
            return;
        }

        var extension = System.IO.Path.GetExtension(loadedFiles.Name);
        if (extension != ".jpg" && extension != ".png" && extension != ".jpeg")
        {
            Message = "Снимката трябва да е .png, .jpg или .jpeg";
            return;
        }

        string path = "/uploadedImages/" + System.Guid.NewGuid() + extension;
        await using FileStream fs = new("wwwroot" + path, FileMode.Create);
        await loadedFiles.OpenReadStream().CopyToAsync(fs);

        Game.Picture = path;
        gameService.AddGame(Game);
        Message = "Добавена!";
    }

    public IBrowserFile? loadedFiles { get; set; } = null;
    public long maxFileSize = 1024 * 1500;
    public bool isLoading;

    public async Task LoadFiles(InputFileChangeEventArgs e)
    {
        isLoading = true;
        try
        {
            loadedFiles = e.File;
        }
        catch (Exception ex)
        {
            Message = $"Error: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }
}
